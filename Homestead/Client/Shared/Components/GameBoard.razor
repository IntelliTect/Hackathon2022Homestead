@using Homestead.Shared
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager Navigation

<div class="map">
    <div class=row gx-1 mb-1>
        @if(CurrentPlayerId == 1)
        {
        <button type="button">Start</button>
        }
    </div>
    <div class="row gx-1 mb-1">
        @foreach (var opponent in Opponents)
        {
            <div class="col">
                <PlayerHomestead Player="@opponent" />
            </div>
        }
    </div>

    <div class="col">
        <PlayerHomestead Player="CurrentPlayer" />
    </div>
</div>

<PlayerHand HandList="@CurrentPlayer.Hand" />


@code {
    [CascadingParameter]
    public int CurrentPlayerId { get; set; }

    private HubConnection? hubConnection;

    private Game GameState { get; set; }

    public List<Player> Opponents { get => GameState.Players.Where(x => x.PlayerNumber != CurrentPlayerId).ToList(); }
    public Player CurrentPlayer { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        //get current player hand information
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/comms"))
            .Build();

        hubConnection.On<Game>("ActionRecieved", (state) =>
        {
            GameState = state;
            InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
        GetCurrentPlayerHand();
        await base.OnInitializedAsync();
    }   

    public void GetCurrentPlayerHand()
    {
        CurrentPlayer = GameState.Players.First(x => x.PlayerNumber == CurrentPlayerId);
    }
}
